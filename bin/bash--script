#!/usr/bin/env bash
set -euo pipefail

# color palette
COLOR_DEBUG=${COLOR_DEBUG:-1} ; color_debug=0
COLOR_INFO=${COLOR_INFO:-34}  ;  color_info=1
COLOR_WARN=${COLOR_WARN:-44}  ;  color_warn=2
COLOR_ERROR=${COLOR_ERROR:-31}; color_error=3

COLOR_PALETTE="${COLOR_PALETTE:-$COLOR_DEBUG $COLOR_INFO $COLOR_WARN $COLOR_ERROR}"
read -r -a colors <<< "$COLOR_PALETTE"

markdown_highlighter() {
  if command -v bat > /dev/null 2>&1; then
    echo "bat --color=always --style=${BAT_STYLE:-plain} --language=markdown"
  else
    echo cat
  fi
}

timestamp() {
  date -u +"${DATE_FORMAT:-%Y-%m-%dT%H:%M:%SZ}"
}

info() {
  ifs0="$IFS"; IFS=""
  while read -r line; do
    >&2 echo -e "$(${return_cursor:-false} && printf "\r")[$(timestamp)] [${color:-${colors[color_info]}}m${line}[0m"
  done < <(echo -e "$@")
  IFS="$ifs0"
}

info_r() {
  return_cursor=true info "$@"
}

warn() {
  color="${color:-${colors[color_warn]}}" info "$@"
}

debug() {
  if ${VERBOSE:-false}; then
    color=${color:-${colors[color_debug]}} info "$@"
  fi
}

print() {
  >&2 printf '%s' "$@"
}

error() {
  color=${color:-${colors[color_error]}} info "$@"
  ${without_help:-true} && exit $WITHOUT_HELP || exit 1
}

eval_cmd() {
  debug "$@"
  eval "$*"
}

cmd() {
  basename "$SCRIPT"
}

version() {
  grep '^# --version' "$SCRIPT" | sed 's/^# --version[ ]*//' ||
  date -r "$SCRIPT" "+%Y.%m.%d"
}

cmd_and_version() {
  echo "$(cmd) (v$(version))"
}

help() {
  printf "[1m%s[22m\n\n" "$(cmd_and_version)"

  sed -n -e '/^# --help$/,/^$/{/^# --help$/d;/--help/d;p;}' < "$SCRIPT"  |
    # strip blank lines & stuff
    sed -E 's/^#( |[ ]*$)//g; $d' |
    ${MARKDOWN:=$(markdown_highlighter)}
}


WITHOUT_HELP=42 # special exit code to exit without printing help message
SCRIPT="${SCRIPT:-$1}"; shift

case "${1:-}" in
  -h|--help)
    help
  ;;
  -v|--version)
    cmd_and_version
  ;;
  *)
    # shellcheck disable=SC1090
    ( source "$SCRIPT" "$@" ) || {
      exit_code=$?
      # only print help if the parent was a shell
      # ie. to avoid *also* printing help for commands that call other bash--script subcommands
      [[ $(ps -o args= $PPID) =~ (bash|fish|zsh)$ ]] && [[ $exit_code -ne $WITHOUT_HELP ]] && help
      exit $exit_code
    }
  ;;
esac

